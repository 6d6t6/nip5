<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NIP-05 Registration 1.3</title>
</head>
<body>
  <h2>Register NIP-05</h2>

  <form id="f">
    <input name="name" placeholder="name" required>
    <input name="npub" placeholder="npub or hex..." required size="60">
    <button>Register</button>
  </form>

  <pre id="out"></pre>

<script>
// ---- Minimal bech32 decoder for npub ----
const CHARSET = "qpzry9x8gf2tvdw0s3jn54khce6mua7l";

function bech32Decode(str) {
  let lower = str.toLowerCase();
  let pos = lower.lastIndexOf("1");
  if (pos < 1) return null;
  let data = lower.slice(pos + 1);
  let values = [];
  for (let c of data) {
    let v = CHARSET.indexOf(c);
    if (v === -1) return null;
    values.push(v);
  }
  values = values.slice(0, -6); // drop checksum

  let bits = 0, buffer = 0, out = [];
  for (let v of values) {
    buffer = (buffer << 5) | v;
    bits += 5;
    if (bits >= 8) {
      bits -= 8;
      out.push((buffer >> bits) & 0xff);
    }
  }
  return out;
}

function bytesToHex(bytes) {
  return bytes.map(b => b.toString(16).padStart(2, "0")).join("");
}

function npubToHex(npub) {
  if (!npub.startsWith("npub1")) return null;
  const decoded = bech32Decode(npub);
  if (!decoded || decoded.length !== 32) return null;
  return bytesToHex(decoded);
}

// ---- Form handler ----
document.getElementById("f").onsubmit = async (e) => {
  e.preventDefault();
  const form = e.target;
  let input = form.npub.value.trim();
  let pubkeyHex;

  // If already hex
  if (/^[0-9a-fA-F]{64}$/.test(input)) {
    pubkeyHex = input.toLowerCase();
  }
  // If npub
  else if (input.startsWith("npub1")) {
    const hex = npubToHex(input);
    if (!hex) {
      document.getElementById("out").textContent = "Invalid npub";
      return;
    }
    pubkeyHex = hex;
  }
  else {
    document.getElementById("out").textContent = "Enter npub or hex public key";
    return;
  }

  const body = {
    name: form.name.value,
    pubkey: pubkeyHex
  };

  const r = await fetch(
    "https://nip5.dooot.workers.dev/register",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    }
  );

  document.getElementById("out").textContent = await r.text();
};
</script>
</body>
</html>
